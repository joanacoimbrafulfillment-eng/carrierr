<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carrier IDs Crosscheck (Standalone - Full Details)</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --card: #0f1b33;
      --card2:#0c1730;
      --text:#e7eefc;
      --muted:#a8b3cf;
      --accent:#5eead4;
      --warn:#fbbf24;
      --bad:#fb7185;
      --good:#34d399;
      --line: rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    body {
      margin:0; background: radial-gradient(1200px 700px at 20% 0%, rgba(94,234,212,.18), transparent 55%),
                         radial-gradient(900px 600px at 90% 20%, rgba(59,130,246,.18), transparent 55%),
                         var(--bg);
      color:var(--text);
    }
    .wrap { max-width: 1100px; margin: 26px auto; padding: 0 16px 42px; }
    .top {
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px; padding: 14px 16px; border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .brand { display:flex; flex-direction:column; gap:2px; }
    .brand h1 { margin:0; font-size: 16px; letter-spacing:.3px; }
    .brand .sub { color: var(--muted); font-size: 12px; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid var(--line); padding: 7px 10px; border-radius: 999px;
      background: rgba(0,0,0,.18); color: var(--muted); font-size: 12px;
    }
    .btn {
      border: 1px solid var(--line); background: rgba(255,255,255,.06);
      color: var(--text); padding: 9px 12px; border-radius: 12px;
      cursor:pointer; transition: .15s transform ease, .15s background ease;
      font-weight: 600; font-size: 13px;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary { border-color: rgba(94,234,212,.4); background: rgba(94,234,212,.10); }
    .btn.primary:hover { background: rgba(94,234,212,.16); }
    .btn.danger { border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); }
    .grid {
      display:grid; grid-template-columns: 1.1fr .9fr; gap: 16px; margin-top: 16px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card {
      border: 1px solid var(--line); background: rgba(255,255,255,.04);
      border-radius: var(--radius); box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd {
      padding: 14px 16px; border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
    }
    .card .hd h2 { margin:0; font-size: 14px; letter-spacing:.2px; }
    .card .bd { padding: 14px 16px; }
    label { display:block; color: var(--muted); font-size: 12px; margin: 10px 0 6px; }
    input, select, textarea {
      width: 100%; box-sizing:border-box;
      border: 1px solid var(--line); background: rgba(0,0,0,.20);
      color: var(--text); border-radius: 12px; padding: 10px 12px;
      outline: none;
    }
    textarea { min-height: 190px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; line-height: 1.35; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    .hint { color: var(--muted); font-size: 12px; margin-top: 8px; }
    .kpis { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 720px) { .kpis { grid-template-columns: 1fr; } }
    .kpi {
      border: 1px solid var(--line); border-radius: 14px; padding: 12px 12px;
      background: rgba(0,0,0,.16);
    }
    .kpi .n { font-size: 24px; font-weight: 800; letter-spacing:.3px; }
    .kpi .t { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .kpi.good .n { color: var(--good); }
    .kpi.bad .n { color: var(--bad); }
    .kpi.warn .n { color: var(--warn); }

    .lists { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    .listbox {
      border: 1px solid var(--line); border-radius: 14px; overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    .listbox .lh {
      padding: 10px 12px; border-bottom: 1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      gap: 8px;
    }
    .listbox .lh b { font-size: 12px; letter-spacing:.2px; }
    .listbox .lh span { color: var(--muted); font-size: 12px; }
    .listbox pre {
      margin:0; padding: 10px 12px; max-height: 200px; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px; line-height: 1.35;
      white-space: pre-wrap; word-break: break-word;
    }
    .status {
      font-size: 12px; color: var(--muted);
    }
    .login {
      max-width: 520px; margin: 60px auto; padding: 0 16px;
    }
    .login .panel {
      border: 1px solid var(--line); border-radius: var(--radius);
      background: rgba(255,255,255,.04); box-shadow: var(--shadow);
      overflow:hidden;
    }
    .login .panel .hd { padding: 16px; border-bottom: 1px solid var(--line); }
    .login .panel .hd h1 { margin:0; font-size: 16px; }
    .login .panel .bd { padding: 16px; }
    .small { font-size: 12px; color: var(--muted); margin-top: 8px; }
    .sep { height: 1px; background: var(--line); margin: 14px 0; }
  
    /* --- Full-details additions --- */
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px 10px; font-size: 12px; vertical-align: top; }
    th { text-align:left; color: var(--muted); font-weight: 700; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding: 3px 8px; border-radius: 999px; border:1px solid var(--line); background: rgba(255,255,255,.06); font-size: 11px; color: var(--muted);}
    .badge.good { border-color: rgba(52,211,153,.35); color: var(--good);}
    .badge.bad { border-color: rgba(251,113,133,.35); color: var(--bad);}
    .badge.warn { border-color: rgba(251,191,36,.35); color: var(--warn);}
    .detailsWrap { max-height: 320px; overflow:auto; }
    .btn.small { padding: 6px 10px; border-radius: 10px; font-size: 12px; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding: 18px; background: rgba(0,0,0,.55); }
    .modal .box { width: min(980px, 96vw); max-height: 86vh; overflow:hidden; border:1px solid var(--line); border-radius: 18px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12)); box-shadow: var(--shadow); }
    .modal .mh { padding: 12px 14px; border-bottom: 1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .modal .mb { padding: 12px 14px; max-height: calc(86vh - 56px); overflow:auto;}
    
    .tabs { display:flex; gap:10px; margin: 10px 0 6px; }
    .tab {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
      transition: .15s transform ease, .15s background ease, .15s color ease;
    }
    .tab:hover { transform: translateY(-1px); background: rgba(255,255,255,.08); color: var(--text); }
    .tab.active { border-color: rgba(94,234,212,.45); background: rgba(94,234,212,.12); color: var(--text); }

    .section { border: 1px solid var(--line); border-radius: 14px; background: rgba(0,0,0,.16); overflow:hidden; margin-bottom: 12px; }
    .section .sh { padding: 10px 12px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .section .sh b { font-size: 12px; letter-spacing: .2px; }
    .section .sb { padding: 10px 12px; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap: 8px 12px; }
    .kv div { font-size: 12px; }
    .kv .k { color: var(--muted); }
    .pillRow { display:flex; gap:8px; flex-wrap:wrap; }
    .mini { font-size: 11px; color: var(--muted); }
    .tableWrap { overflow:auto; }
    .tmini th, .tmini td { font-size: 12px; }
    details.raw { border: 1px solid var(--line); border-radius: 14px; background: rgba(0,0,0,.16); padding: 10px 12px; }
    details.raw summary { cursor:pointer; font-weight:800; font-size: 12px; color: var(--text); }

    pre.json { margin:0; white-space: pre-wrap; word-break: break-word; font-size: 12px; line-height:1.35; background: rgba(0,0,0,.22); border: 1px solid var(--line); border-radius: 14px; padding: 10px 12px; }


    /* --- High-contrast modal (readability) --- */
    .modal .box{ background:#f8fafc !important; color:#0f172a !important; border-color: rgba(15,23,42,.18) !important; }
    .modal .mh{ background:#eef2ff !important; border-bottom-color: rgba(15,23,42,.12) !important; }
    .modal .mb{ background:#f8fafc !important; }
    .modal .mh .mini, .modal .box .mini{ color:#334155 !important; }
    .modal .box .badge{ background:#ffffff !important; border-color: rgba(15,23,42,.18) !important; color:#334155 !important; }
    .modal .box .badge.good{ border-color: rgba(5,150,105,.35) !important; color:#047857 !important; }
    .modal .box .badge.bad{ border-color: rgba(225,29,72,.25) !important; color:#be123c !important; }
    .modal .box .badge.warn{ border-color: rgba(217,119,6,.25) !important; color:#b45309 !important; }
    .modal .box .section{ background:#ffffff !important; border-color: rgba(15,23,42,.14) !important; }
    .modal .box .section .sh{ background:#f1f5f9 !important; border-bottom-color: rgba(15,23,42,.10) !important; }
    .modal .box .kv .k{ color:#475569 !important; }
    .modal .box table th{ color:#475569 !important; }
    .modal .box table th, .modal .box table td{ border-bottom-color: rgba(15,23,42,.10) !important; }
    .modal .box details.raw{ background:#ffffff !important; border-color: rgba(15,23,42,.14) !important; }
    .modal .box details.raw summary{ color:#0f172a !important; }
    .modal .box pre.json{ background:#ffffff !important; color:#0f172a !important; border-color: rgba(15,23,42,.14) !important; }
    .modal .box a{ color:#0f172a !important; text-decoration: underline; }
    .modal .box .tab{ background:#ffffff !important; color:#334155 !important; border-color: rgba(15,23,42,.18) !important; }
    .modal .box .tab:hover{ background:#f1f5f9 !important; color:#0f172a !important; }
    .modal .box .tab.active{ background:#dbeafe !important; border-color: rgba(37,99,235,.35) !important; color:#0f172a !important; }
    .modal .box .btn{ background:#ffffff !important; color:#0f172a !important; border-color: rgba(15,23,42,.18) !important; }
    .modal .box .btn:hover{ background:#f1f5f9 !important; }
    .modal .box .btn.primary{ background:#dbeafe !important; border-color: rgba(37,99,235,.35) !important; }
    .modal .box .btn.danger{ background:#ffe4e6 !important; border-color: rgba(225,29,72,.25) !important; }

  
  /* --- Cancel warning banner --- */
  .cancel-banner{display:none; position:sticky; top:0; z-index:30; background:#fff3f3; border:1px solid #ffb3b3; color:#5a0000;
    padding:10px 12px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 12px rgba(0,0,0,.08);}
  .cancel-banner .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
  .cancel-banner .row .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .cancel-banner .cancel-pill{background:#b00020; color:#fff; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:800; letter-spacing:.2px;}
  .cancel-banner .mini{opacity:.9;}
  .cancel-banner .ids{width:100%; margin-top:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    white-space:pre-wrap; background:#fff; border:1px dashed #ffb3b3; padding:8px; border-radius:10px; max-height:160px; overflow:auto;}

</style>
</head>
<body>

  <div id="login" class="login" style="display:none;">
    <div class="panel">
      <div class="hd">
        <h1>Carrier IDs Crosscheck</h1>
        <div class="small">Standalone ‚Ä¢ liga ao mesmo Firebase do sistema principal</div>
      </div>
      <div class="bd">
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="email" autocomplete="username" />
        <label>Password</label>
        <input id="loginPass" type="password" placeholder="password" autocomplete="current-password" />
        <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
          <button class="btn primary" onclick="handleLogin()">Entrar</button>
          <span id="loginMsg" class="status"></span>
        </div>
        <div class="sep"></div>
        <div class="small">
          Nota: se as regras da BD exigirem autentica√ß√£o, tens de entrar com as mesmas credenciais do sistema principal.
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="wrap" style="display:none;">
    <div class="top">
      <div class="brand">
        <h1>Carrier IDs Crosscheck</h1>
        <div class="sub">Cruzamento de IDs da transportadora vs IDs do sistema (por intervalo de datas e carrier)</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <div class="pill"><span>üë§</span><span id="userPill">‚Äî</span></div>
        <div class="pill"><span>üóÑÔ∏è</span><span id="dbPill">DB: ‚Ä¶</span></div>
        <button class="btn danger" onclick="logout()">Sair</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>Inputs</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" onclick="loadCarriersForRange()">Atualizar transportadoras</button>
            <button class="btn primary" onclick="runCrosscheck()">Comparar</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Data in√≠cio</label>
              <input id="dateFrom" type="date" />
            </div>
            <div>
              <label>Data fim</label>
              <input id="dateTo" type="date" />
              <div class="hint">Se n√£o escolheres fim, assume a data in√≠cio.</div>
            </div>
            <div>
              <label>Transportadora(s)</label>
              <select id="carriers" multiple size="6"></select>
              <div class="hint">Seleciona 2+ com Ctrl/Cmd + clique. A lista √© carregada dos lotes (active_batches) dentro do intervalo.</div>
            </div>
          </div>

          <div class="tabs" role="tablist" aria-label="Modo">
            <button id="tabShip" class="tab active" onclick="setTab('SHIP')" type="button">ENVIOS</button>
            <button id="tabReturns" class="tab" onclick="setTab('RETURNS')" type="button">RETURNS</button>
          </div>
          <div class="hint" id="tabHint">Modo atual: <b>ENVIOS</b> ‚Äî compara a lista da transportadora com IDs EXPECTED/PACKED/CANCELLED no intervalo.</div>

          <div class="row">
            <div>
              <label>Comparar com</label>
              <select id="compareMode"></select>
              <div class="hint">
                ‚Ä¢ PACKED = IDs processados em PACKING dentro do intervalo para essa(s) transportadora(s).<br/>
                ‚Ä¢ EXPECTED = expected_ids dos lotes dentro do intervalo (exclui cancelled_ids).
              </div>
            </div>
            <div>
              <label>Filtro extra</label>
              <select id="extraFilter">
                <option value="ONLY_PACKING">S√≥ mode=PACKING (recomendado)</option>
                <option value="ALL_MODES">Todos os modos (PACKING/RETURNS/etc.)</option>
              </select>
              <div class="hint">S√≥ aplicado quando ‚ÄúComparar com = PACKED‚Äù.</div>
            </div>
          </div>

          <div style="margin-top:10px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background: rgba(0,0,0,.16);">
            <label style="margin:0 0 6px;">Detalhe (dados completos)</label>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <label style="margin:0; display:flex; gap:8px; align-items:center; color: var(--muted); font-size:12px;">
                <input type="checkbox" id="includeAllRegistos" checked />
                Incluir historico completo em registos (pode ser lento)
              </label>
              <span class="hint" style="margin:0;">Mesmo com isto desligado, o sistema mostra id_history + dados do lote.</span>
            </div>
          </div>

          <label>IDs enviados pela transportadora (colar aqui)</label>
          <textarea id="carrierIds" placeholder="Cola aqui a lista (linhas, espa√ßos, v√≠rgulas...)
Ex:
12345678
12345679
..."></textarea>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center;">
            <button class="btn" onclick="pasteFromClipboard()">Colar do clipboard</button>
            <button class="btn" onclick="clearInput()">Limpar</button>
            <span id="status" class="status"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Resultado</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" onclick="exportXlsx()">Export XLSX</button>
            <button class="btn" onclick="copySummary()">Copiar resumo</button>
          </div>
        </div>
        <div class="bd">
          <div id="cancelBanner" class="cancel-banner"></div>
          <div class="kpis">
            <div class="kpi good">
              <div class="n" id="kMatched">0</div>
              <div class="t">Matched (OK)</div>
            </div>
            <div class="kpi bad">
              <div class="n" id="kMissing">0</div>
              <div class="t">Missing (faltam)</div>
            </div>
            <div class="kpi warn">
              <div class="n" id="kExtra">0</div>
              <div class="t">Extra (sobram)</div>
            </div>
          </div>

          <div class="lists">
            <div class="listbox">
              <div class="lh">
                <div><b>Matched</b> <span id="cMatched">0</span></div>
                <div style="display:flex; gap:8px;">
                  <button class="btn" onclick="copyList('matched')">Copiar</button>
                </div>
              </div>
              <pre id="matched"></pre>
            </div>

            <div class="listbox">
              <div class="lh">
                <div><b>Missing</b> <span id="cMissing">0</span></div>
                <div style="display:flex; gap:8px;">
                  <button class="btn" onclick="copyList('missing')">Copiar</button>
                </div>
              </div>
              <pre id="missing"></pre>
            </div>

            <div class="listbox">
              <div class="lh">
                <div><b>Extra</b> <span id="cExtra">0</span></div>
                <div style="display:flex; gap:8px;">
                  <button class="btn" onclick="copyList('extra')">Copiar</button>
                </div>
              </div>
              <pre id="extra"></pre>
            </div>

            <div class="listbox">
              <div class="lh">
                <div><b>Detalhe por ID</b> <span id="cDetails">0</span></div>
                <div style="display:flex; gap:8px;">
                  <button class="btn small" onclick="copyDetailsCsv()">Copiar tabela</button>
                </div>
              </div>
              <div class="detailsWrap">
                <table id="detailsTable">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Na lista?</th>
                      <th>EXPECTED</th>
                      <th>PACKED</th>
                      <th>RETURNS</th>
                      <th>CANCELLED</th>
                      <th>Ultimo evento</th>
                      <th>Lote(s)</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="hint" id="techHint"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="idModal" class="modal" onclick="closeIdModal(event)">
    <div class="box" onclick="event.stopPropagation()">
      <div class="mh">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <div style="font-weight:800; letter-spacing:.2px;" id="idModalTitle">ID</div>
          <div style="font-size:12px; color: var(--muted);" id="idModalSubtitle"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn small" onclick="copyModalJson()">Copiar JSON</button>
          <button class="btn small" onclick="closeIdModal()">Fechar</button>
        </div>
      </div>
      <div class="mb">
        <div id="idModalBody">(sem dados)</div>
      </div>
    </div>
  </div>


<script>
  // --- Firebase init (copiado do sistema principal) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDExvgmtrSILCATQgE8ICJX-SVntb5lM2Y",
    authDomain: "wh-murtede.firebaseapp.com",
    projectId: "wh-murtede",
    databaseURL: "https://wh-murtede-default-rtdb.europe-west1.firebasedatabase.app",
    storageBucket: "wh-murtede.firebasestorage.app",
    messagingSenderId: "415946575714",
    appId: "1:415946575714:web:b1516b91b9735b9248e63b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // DB connected badge
  try {
    db.ref('.info/connected').on('value', (snap) => {
      const ok = !!snap.val();
      document.getElementById('dbPill').textContent = 'DB: ' + (ok ? 'CONNECTED' : 'OFFLINE');
    });
  } catch(e) {
    document.getElementById('dbPill').textContent = 'DB: UNKNOWN';
  }

  // --- UI state ---
  let lastResult = {
    date: null, carriers: [], compareMode: null,
    matched: [], missing: [], extra: [],
    carrierIdsCount: 0, systemIdsCount: 0,
    batchKeys: []
  
  };

  // --- Tabs (ENVIOS vs RETURNS) ---
  let currentTab = 'SHIP';

  const compareOptions = {
    SHIP: [
      { v: 'ALL', t: 'ALL (EXPECTED + PACKED + CANCELLED)' },
      { v: 'PACKED', t: 'PACKED no intervalo (registos)' },
      { v: 'EXPECTED', t: 'EXPECTED no intervalo (lotes)' },
    ],
    RETURNS: [
      { v: 'RETURNS', t: 'RETURNS no intervalo (registos mode=RETURNS)' },
      { v: 'PACKED_RETURNS', t: 'PACKED + RETURNS (union)' },
      { v: 'ALL_PLUS_RETURNS', t: 'ALL + RETURNS (EXPECTED + PACKED + RETURNS + CANCELLED)' },
    ]
  };

  function fillCompareMode(){
    const sel = $('compareMode');
    const cur = sel.value;
    sel.innerHTML = '';
    (compareOptions[currentTab] || []).forEach(o=>{
      const opt = document.createElement('option');
      opt.value = o.v;
      opt.textContent = o.t;
      sel.appendChild(opt);
    });
    // keep previous if compatible
    const values = new Set(Array.from(sel.options).map(o=>o.value));
    if(values.has(cur)) sel.value = cur;
  }

  function setTab(tab){
    currentTab = tab;
    $('tabShip').classList.toggle('active', tab === 'SHIP');
    $('tabReturns').classList.toggle('active', tab === 'RETURNS');

    fillCompareMode();

    if(tab === 'SHIP'){
      $('tabHint').innerHTML = 'Modo atual: <b>ENVIOS</b> ‚Äî compara a lista da transportadora com IDs EXPECTED/PACKED/CANCELLED no intervalo.';
      $('extraFilter').disabled = false;
      $('extraFilter').closest('div').querySelector('.hint').textContent = 'S√≥ aplicado quando ‚ÄúComparar com = PACKED‚Äù.';
    } else {
      $('tabHint').innerHTML = 'Modo atual: <b>RETURNS</b> ‚Äî compara a lista da transportadora com IDs que aparecem em <b>RETURNS</b> no intervalo (filtrado pelos lotes das transportadoras selecionadas).';
      // extraFilter n√£o faz sentido aqui; mantemos enabled apenas para PACKED dentro dos modos UNION
      $('extraFilter').disabled = false;
      $('extraFilter').closest('div').querySelector('.hint').textContent = 'Aplicado apenas ao componente PACKED (quando o modo inclui PACKED).';
    }

    // reset results visually
    setStatus('');
    setKPIs([], [], []);
    $('detailsTable').querySelector('tbody').innerHTML = '';
    $('cDetails').textContent = '0';
    $('techHint').textContent = '';
  }

  function getSelectedCarriers(){
    const sel = $('carriers');
    if(!sel) return [];
    return Array.from(sel.selectedOptions).map(o=>String(o.value||'').trim()).filter(Boolean);
  }

  function carriersLabel(carriers){
    const arr = Array.isArray(carriers) ? carriers : (carriers ? [carriers] : []);
    return arr.join(', ');
  }

  function $(id) { return document.getElementById(id); }

  function setStatus(msg) {
    $('status').textContent = msg || '';
  }

  function _summCancelLine(id, cancelledToday){
    const arr = (cancelledToday && cancelledToday[id]) ? cancelledToday[id] : [];
    if(!arr.length) return id;
    const c0 = arr[0] || {};
    const info = c0.cancelInfo || {};
    const reason = info.reason || info.motivo || info.note || '';
    const who = info.user || info.by || info.username || '';
    const when = info.DateTime || info.datetime || info.ts || info.time || '';
    const bits = [];
    if(reason) bits.push(reason);
    if(who) bits.push(who);
    if(when) bits.push(when);
    return bits.length ? `${id} ‚Äî ${bits.join(' ¬∑ ')}` : id;
  }

  async function _copyText(txt){
    try { await navigator.clipboard.writeText(txt); setStatus('Copiado ‚úÖ'); }
    catch(e){ alert('Nao consegui copiar.'); }
  }

  function hideCancelBanner(){
    const el = $('cancelBanner'); if(!el) return;
    el.style.display = 'none';
    el.innerHTML = '';
  }

  function showCancelBanner(payload){
    const el = $('cancelBanner'); if(!el) return;
    const {cancelAll, cancelInCarrier, cancelOnlySystem, cancelledToday} = payload || {};
    const nAll = (cancelAll||[]).length;
    const nIn = (cancelInCarrier||[]).length;
    const nOnly = (cancelOnlySystem||[]).length;

    if(!nAll){ hideCancelBanner(); return; }

    const linesIn = (cancelInCarrier||[]).slice(0, 80).map(id=>_summCancelLine(id, cancelledToday));
    const linesOnly = (cancelOnlySystem||[]).slice(0, 80).map(id=>_summCancelLine(id, cancelledToday));

    let details = '';
    if(nIn){
      details += `\n\nüìå Cancelados E aparecem na lista da transportadora (${nIn}):\n` + linesIn.join('\n');
      if(nIn>80) details += `\n... (+${nIn-80})`;
    }
    if(nOnly){
      details += `\n\nüßæ Cancelados no sistema (n√£o estavam na lista colada) (${nOnly}):\n` + linesOnly.join('\n');
      if(nOnly>80) details += `\n... (+${nOnly-80})`;
    }
    const headline = `‚ö†Ô∏è Encontrados ${nAll} ID(s) CANCELADOS no sistema dentro do intervalo/transportadoras selecionadas.`;

    el.innerHTML = `
      <div class="row">
        <div class="left">
          <span class="cancel-pill">CANCELADOS</span>
          <b>${_esc(headline)}</b>
          <span class="mini">Isto pode explicar ‚ÄúMissing‚Äù (o sistema tinha o ID mas foi cancelado).</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" onclick="copyCancelledSummary()">Copiar</button>
          <button class="btn" onclick="hideCancelBanner()">Fechar</button>
        </div>
      </div>
      <div class="ids" id="cancelBannerTxt">${_esc(details.trim() || '(sem detalhe)')}</div>
    `;
    el.style.display = 'block';
  }

  function copyCancelledSummary(){
    const txtEl = $('cancelBannerTxt');
    if(!txtEl) return;
    _copyText(txtEl.textContent || '');
  }

  function setLoginMsg(msg) {
    $('loginMsg').textContent = msg || '';
  }

  // Parse IDs: aceita linhas/virgulas/espa√ßos e apanha tokens alfanum√©ricos
  function parseIds(raw) {
    const s = (raw || '').toString();
    const tokens = s.match(/[A-Za-z0-9_-]+/g) || [];
    const norm = tokens.map(t => t.trim().toUpperCase()).filter(Boolean);
    // dedupe mantendo ordem
    const seen = new Set();
    const out = [];
    for (const id of norm) {
      if (!seen.has(id)) { seen.add(id); out.push(id); }
    }
    return out;
  }

  function getRequiredBatchIds(batch) {
    const expected = (batch && batch.expected_ids) ? batch.expected_ids : [];
    const cancelled = (batch && batch.cancelled_ids) ? Object.keys(batch.cancelled_ids) : [];
    const cancelledSet = new Set(cancelled);
    return expected.filter(id => !cancelledSet.has(id));
  }

    function inRange(dc, from, to){
    const s = String(dc||'');
    return !!s && s >= String(from||'') && s <= String(to||'');
  }

function toSet(arr) {
    const s = new Set();
    (arr || []).forEach(x => s.add(String(x).trim().toUpperCase()));
    return s;
  }

  function setKPIs(matched, missing, extra) {
    $('kMatched').textContent = matched.length;
    $('kMissing').textContent = missing.length;
    $('kExtra').textContent   = extra.length;

    $('cMatched').textContent = matched.length;
    $('cMissing').textContent = missing.length;
    $('cExtra').textContent   = extra.length;

    $('matched').textContent = matched.join('\n');
    $('missing').textContent = missing.join('\n');
    $('extra').textContent   = extra.join('\n');
  }

  function setTechHint(txt) {
    $('techHint').textContent = txt || '';
  }

  function todayISO() {
    const d = new Date();
    const tzOff = d.getTimezoneOffset() * 60000;
    return new Date(d.getTime() - tzOff).toISOString().slice(0,10);
  }

  async function handleLogin() {
    setLoginMsg('A entrar‚Ä¶');
    try {
      const e = $('loginEmail').value.trim();
      const p = $('loginPass').value;
      await auth.signInWithEmailAndPassword(e, p);
      setLoginMsg('');
    } catch(err) {
      console.error(err);
      setLoginMsg('Credenciais inv√°lidas ou sem permiss√µes.');
    }
  }

  async function logout() {
    try { await auth.signOut(); } catch(e) {}
  }

  auth.onAuthStateChanged((user) => {
    if (!user) {
      $('app').style.display = 'none';
      $('login').style.display = 'block';
      return;
    }
    $('login').style.display = 'none';
    $('app').style.display = 'block';
    $('userPill').textContent = user.email || 'signed-in';

    // default dates = hoje
    if (!$('dateFrom').value) $('dateFrom').value = todayISO();
    if (!$('dateTo').value) $('dateTo').value = $('dateFrom').value;
    loadCarriersForRange();
    fillCompareMode();
    setTab('SHIP');
  });

  async function loadCarriersForRange() {
    const dateFrom = $('dateFrom').value;
    const dateTo = $('dateTo').value || dateFrom;
    if (!dateFrom) return;
    if (!dateTo) return;

    if (dateTo < dateFrom) {
      alert('A data fim n√£o pode ser anterior √† data in√≠cio.');
      return;
    }

    setStatus('A carregar transportadoras‚Ä¶');
    const carriers = new Set();
    let countBatches = 0;
    let usedFallback = false;

    try {
      // melhor cen√°rio: query indexada por dateClean (range)
      const snap = await db.ref('active_batches').orderByChild('dateClean').startAt(dateFrom).endAt(dateTo).once('value');
      const batches = snap.val() || {};
      Object.keys(batches).forEach(k => {
        const b = batches[k] || {};
        const dc = String(b.dateClean || '');
        if (!dc) return;
        if (dc < dateFrom || dc > dateTo) return;
        if (b.carrier) carriers.add(String(b.carrier));
        countBatches++;
      });
    } catch(e) {
      console.warn('Query range por dateClean falhou; fallback full-scan', e);
      usedFallback = true;
      const snap = await db.ref('active_batches').once('value');
      const batches = snap.val() || {};
      Object.keys(batches).forEach(k => {
        const b = batches[k] || {};
        const dc = String(b.dateClean || '');
        if (!dc) return;
        if (dc < dateFrom || dc > dateTo) return;
        if (b.carrier) carriers.add(String(b.carrier));
        countBatches++;
      });
    }

    // preencher select
    const sel = $('carriers');
    const prev = Array.from(sel.selectedOptions).map(o=>o.value);
    sel.innerHTML = '';
    const arr = Array.from(carriers).sort((a,b)=>a.localeCompare(b));
    if (arr.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '‚Äî sem lotes nesse intervalo ‚Äî';
      sel.appendChild(opt);
    } else {
      arr.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      // repor selecao anterior
      const prevSet = new Set(prev);
      Array.from(sel.options).forEach(o => { o.selected = prevSet.has(o.value); });
      // se nao havia selecao, seleciona a primeira por defeito
      if (getSelectedCarriers().length === 0 && arr.length > 0) sel.options[0].selected = true;
    }

    setStatus(`Transportadoras carregadas: ${arr.length} ‚Ä¢ lotes: ${countBatches}${usedFallback ? ' (fallback)' : ''}`);
  }

  async function runCrosscheck() {
    const date = $('day').value;
    const carriers = getSelectedCarriers();
    const compareMode = $('compareMode').value;
    const extraFilter = $('extraFilter').value;

    if (!date) { alert('Seleciona o dia.'); return; }
    if (!carriers.length) { alert('Seleciona pelo menos 1 transportadora.'); return; }

    const carrierIds = parseIds($('carrierIds').value);
    if (carrierIds.length === 0) {
      alert('Cola pelo menos 1 ID da transportadora.');
      return;
    }

    setStatus('A cruzar‚Ä¶');
    setTechHint('');
    setKPIs([], [], []);

    // 1) Buscar lotes do dia + carrier
    let batches = {};
    let usedFallbackBatches = false;
    try {
      const snap = await db.ref('active_batches').orderByChild('dateClean').equalTo(date).once('value');
      batches = snap.val() || {};
    } catch(e) {
      usedFallbackBatches = true;
      const snap = await db.ref('active_batches').once('value');
      const all = snap.val() || {};
      Object.keys(all).forEach(k => {
        const b = all[k] || {};
        if (b.dateClean === date) batches[k] = b;
      });
    }

    const carriersSet = new Set(carriers.map(c=>String(c)));
    const batchKeys = Object.keys(batches).filter(k => {
      const b = batches[k] || {};
      return carriersSet.has(String(b.carrier || ''));
    });

    if (batchKeys.length === 0) {
      setStatus('Sem lotes encontrados para esse dia/carrier.');
      setTechHint('Confirma se a transportadora est√° correta e se os lotes t√™m dateClean e carrier preenchidos.');
      return;
    }

    // 2) IDs do sistema (PACKED ou EXPECTED)
    let systemIds = [];
    let usedFallbackReg = false;

    if (compareMode === 'EXPECTED') {
      batchKeys.forEach(k => {
        const b = batches[k] || {};
        const req = getRequiredBatchIds(b);
        req.forEach(id => systemIds.push(String(id).trim().toUpperCase()));
      });
      systemIds = Array.from(new Set(systemIds));
    } else {
      let registos = {};
      try {
        const snap = await db.ref('registos').orderByChild('dateClean').equalTo(date).once('value');
        registos = snap.val() || {};
      } catch(e) {
        usedFallbackReg = true;
        const snap = await db.ref('registos').once('value');
        const all = snap.val() || {};
        Object.keys(all).forEach(k => {
          const r = all[k] || {};
          if (r.dateClean === date) registos[k] = r;
        });
      }

      const batchSet = new Set(batchKeys);
      const ids = [];
      Object.values(registos).forEach(r => {
        if (!r) return;
        if (!batchSet.has(r.batch)) return;
        if (extraFilter === 'ONLY_PACKING' && String(r.mode) !== 'PACKING') return;
        if (!r.id) return;
        ids.push(String(r.id).trim().toUpperCase());
      });
      systemIds = Array.from(new Set(ids));
    }

    // 3) Cruzamento
    const carrierSet = toSet(carrierIds);
    const systemSet = toSet(systemIds);

    const matched = [];
    const missing = [];
    const extra = [];

    systemIds.forEach(id => {
      const nid = String(id).trim().toUpperCase();
      if (carrierSet.has(nid)) matched.push(nid);
      else missing.push(nid);
    });

    carrierIds.forEach(id => {
      const nid = String(id).trim().toUpperCase();
      if (!systemSet.has(nid)) extra.push(nid);
    });

    matched.sort();
    missing.sort();
    extra.sort();

    lastResult = {
      date, carriers, compareMode,
      matched, missing, extra,
      carrierIdsCount: carrierIds.length,
      systemIdsCount: systemIds.length,
      batchKeys
    };

    setKPIs(matched, missing, extra);

    const hints = [];
    hints.push(`Intervalo: ${date} ‚Ä¢ Carriers: ${carriersLabel(carriers)} ‚Ä¢ Base: ${compareMode}`);
    hints.push(`IDs transportadora: ${carrierIds.length} ‚Ä¢ IDs sistema: ${systemIds.length} ‚Ä¢ Lotes: ${batchKeys.length}`);
    if (usedFallbackBatches) hints.push('Nota: query por dateClean em active_batches falhou ‚Üí usado fallback full-scan.');
    if (compareMode === 'PACKED' && usedFallbackReg) hints.push('Nota: query por dateClean em registos falhou ‚Üí usado fallback full-scan.');
    setTechHint(hints.join(' | '));

    setStatus('Conclu√≠do ‚úÖ');
  }

  async function pasteFromClipboard() {
    try {
      const t = await navigator.clipboard.readText();
      $('carrierIds').value = t || '';
    } catch(e) {
      alert('N√£o consegui aceder ao clipboard (permite acesso no browser).');
    }
  }

  function clearInput() {
    $('carrierIds').value = '';
    setStatus('');
  }

  async function copyList(which) {
    const map = {
      matched: lastResult.matched,
      missing: lastResult.missing,
      extra: lastResult.extra
    };
    const arr = map[which] || [];
    try {
      await navigator.clipboard.writeText(arr.join('\n'));
      setStatus('Lista copiada ‚úÖ');
    } catch(e) {
      alert('N√£o consegui copiar.');
    }
  }

  async function copySummary() {
    const r = lastResult;
    if (!r || !r.dateFrom) { alert('Faz uma compara√ß√£o primeiro.'); return; }
    const txt =
`CROSSCHECK ‚Äî ${r.dateFrom} ‚Üí ${r.dateTo} ‚Äî ${carriersLabel(r.carriers)}
Base: ${r.compareMode}
IDs Transportadora: ${r.carrierIdsCount}
IDs Sistema: ${r.systemIdsCount}
Lotes: ${r.batchKeys.length}

Matched: ${r.matched.length}
Missing: ${r.missing.length}
Extra: ${r.extra.length}`;
    try {
      await navigator.clipboard.writeText(txt);
      setStatus('Resumo copiado ‚úÖ');
    } catch(e) {
      alert('N√£o consegui copiar.');
    }
  }

  function exportXlsx() {
    const r = lastResult;
    if (!r || !r.dateFrom) { alert('Faz uma compara√ß√£o primeiro.'); return; }

    const rows = [];
    const add = (status, id) => rows.push({ DateFrom: r.dateFrom, DateTo: r.dateTo, Carriers: carriersLabel(r.carriers), Base: r.compareMode, Status: status, ID: id });
    r.matched.forEach(id => add('MATCHED', id));
    r.missing.forEach(id => add('MISSING', id));
    r.extra.forEach(id => add('EXTRA', id));

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Crosscheck");

    const summary = [
      { Key: 'DateFrom', Value: r.dateFrom },
        { Key: 'DateTo', Value: r.dateTo },
      { Key: 'Carriers', Value: carriersLabel(r.carriers) },
      { Key: 'Base', Value: r.compareMode },
      { Key: 'Carrier IDs', Value: r.carrierIdsCount },
      { Key: 'System IDs', Value: r.systemIdsCount },
      { Key: 'Batches', Value: r.batchKeys.length },
      { Key: 'Matched', Value: r.matched.length },
      { Key: 'Missing', Value: r.missing.length },
      { Key: 'Extra', Value: r.extra.length },
    ];
    const ws2 = XLSX.utils.json_to_sheet(summary);
    XLSX.utils.book_append_sheet(wb, ws2, "Summary");

    const fname = `carrier_crosscheck_${r.dateFrom}_to_${r.dateTo}_${String(carriersLabel(r.carriers)||'carriers').replace(/\s+/g,'_').replace(/,+/g,'+')}.xlsx`;
    XLSX.writeFile(wb, fname);
  }

  document.addEventListener('DOMContentLoaded', () => {
    $('dateFrom').addEventListener('change', () => loadCarriersForRange());
    $('dateTo').addEventListener('change', () => loadCarriersForRange());
  });


  // ===== Full-details additions =====
  function _esc(s){
    return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }
  function _yesNoBadge(ok){
    return ok ? '<span class="badge good">YES</span>' : '<span class="badge bad">NO</span>';
  }
  function closeIdModal(evt){
    if(evt && evt.target && evt.target.id !== 'idModal') return;
    $('idModal').style.display = 'none';
  }

  let currentModalId = null;
  async function copyModalJson(){
    if(!currentModalId){ return alert('Sem ID no modal.'); }
    const d = (lastResult && lastResult.detailsById) ? lastResult.detailsById[currentModalId] : null;
    const txt = d ? JSON.stringify(d, null, 2) : '';
    try {
      await navigator.clipboard.writeText(txt);
      setStatus('JSON copiado ‚úÖ');
    } catch(e){
      alert('Nao consegui copiar.');
    }
  }

  
  function _fmt(v){
    if(v === null || v === undefined) return '';
    if(typeof v === 'object'){
      try { return JSON.stringify(v); } catch(e) { return String(v); }
    }
    return String(v);
  }

  function _safeTxt(s){ return _esc(String(s ?? '')); }

  function _modeBadge(label, n){
    const cls = n ? 'good' : '';
    return `<span class="badge ${cls}">${_safeTxt(label)}: ${Number(n||0)}</span>`;
  }

  function _renderMiniTable(rows, cols){
    if(!rows || !rows.length) return `<div class="mini">(sem registos)</div>`;
    const head = cols.map(c=>`<th>${_safeTxt(c.h)}</th>`).join('');
    const body = rows.map(r=>{
      return '<tr>' + cols.map(c=>`<td>${_safeTxt(c.f(r))}</td>`).join('') + '</tr>';
    }).join('');
    return `<div class="tableWrap"><table class="tmini"><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></div>`;
  }

  function openIdModal(id){
    const d = (lastResult && lastResult.detailsById) ? lastResult.detailsById[id] : null;
    $('idModalTitle').textContent = id;
    currentModalId = id;

    if(!d){
      $('idModalSubtitle').textContent = '';
      $('idModalBody').innerHTML = '<div class="mini">(sem dados)</div>';
      $('idModal').style.display = 'flex';
      return;
    }

    const expN = (d.expectedToday||[]).length;
    const packN = (d.packedToday||[]).length;
    const retN = (d.returnsToday||[]).length;
    const canN = (d.cancelledToday||[]).length;

    const sub = [];
    sub.push(`${d.dateFrom} ‚Üí ${d.dateTo}`);
    sub.push(carriersLabel(d.carriers));
    $('idModalSubtitle').textContent = sub.join(' ‚Ä¢ ');

    const batches = (d.expectedToday||[]).map(x=>x.batchKey)
      .concat((d.cancelledToday||[]).map(x=>x.batchKey))
      .concat((d.packedToday||[]).map(x=>x.batch))
      .concat((d.returnsToday||[]).map(x=>x.batch))
      .filter(Boolean);
    const uniqB = Array.from(new Set(batches));

    const orderDet = (d.expectedToday && d.expectedToday[0] && d.expectedToday[0].orderDetails) ? d.expectedToday[0].orderDetails : null;

    const summaryHtml = `
      <div class="section">
        <div class="sh">
          <b>Resumo</b>
          <div class="pillRow">
            ${_modeBadge('IN LIST', d.inCarrierList ? 1 : 0)}
            ${_modeBadge('EXPECTED', expN)}
            ${_modeBadge('PACKED', packN)}
            ${_modeBadge('RETURNS', retN)}
            ${_modeBadge('CANCELLED', canN)}
          </div>
        </div>
        <div class="sb">
          <div class="kv">
            <div class="k">ID</div><div><b>${_safeTxt(id)}</b></div>
            <div class="k">No intervalo</div><div>${_safeTxt(d.dateFrom)} ‚Üí ${_safeTxt(d.dateTo)}</div>
            <div class="k">Transportadoras</div><div>${_safeTxt(carriersLabel(d.carriers))}</div>
            <div class="k">Lotes</div><div>${_safeTxt(uniqB.join(', ') || '(nenhum)')}</div>
            <div class="k">Order details</div><div>${orderDet ? _safeTxt(JSON.stringify(orderDet)) : '<span class="mini">(sem order_details)</span>'}</div>
          </div>
        </div>
      </div>
    `;

    const expectedHtml = `
      <div class="section">
        <div class="sh"><b>EXPECTED (lotes)</b><span class="mini">${expN} registo(s)</span></div>
        <div class="sb">
          ${_renderMiniTable(d.expectedToday, [
            {h:'Data', f:(r)=>r.dateClean||''},
            {h:'Batch', f:(r)=>r.batchKey||''},
            {h:'Processado?', f:(r)=>r.processed?'YES':'NO'},
            {h:'Cliente', f:(r)=> (r.orderDetails && (r.orderDetails.name||r.orderDetails.customer||'')) || ''},
            {h:'Conteudo', f:(r)=> (r.orderDetails && (r.orderDetails.content||'')) || ''},
          ])}
        </div>
      </div>
    `;

    const packedHtml = `
      <div class="section">
        <div class="sh"><b>PACKED (registos)</b><span class="mini">${packN} registo(s)</span></div>
        <div class="sb">
          ${_renderMiniTable(d.packedToday, [
            {h:'Data', f:(r)=>r.dateClean||''},
            {h:'Hora', f:(r)=>r.endTime||r.time||r.startTime||''},
            {h:'User', f:(r)=>r.user||''},
            {h:'Batch', f:(r)=>r.batch||''},
            {h:'Track', f:(r)=>r.track||r.tracking||''},
            {h:'Items', f:(r)=>r.prods||''},
          ])}
        </div>
      </div>
    `;

    const returnsHtml = `
      <div class="section">
        <div class="sh"><b>RETURNS (registos)</b><span class="mini">${retN} registo(s)</span></div>
        <div class="sb">
          ${_renderMiniTable(d.returnsToday, [
            {h:'Data', f:(r)=>r.dateClean||''},
            {h:'Hora', f:(r)=>r.endTime||r.time||r.startTime||''},
            {h:'User', f:(r)=>r.user||''},
            {h:'Batch', f:(r)=>r.batch||''},
            {h:'Items', f:(r)=>r.prods||''},
          ])}
        </div>
      </div>
    `;

    const cancelledHtml = `
      <div class="section">
        <div class="sh"><b>CANCELLED (lotes)</b><span class="mini">${canN} registo(s)</span></div>
        <div class="sb">
          ${_renderMiniTable(d.cancelledToday, [
            {h:'Data', f:(r)=>r.dateClean||''},
            {h:'Batch', f:(r)=>r.batchKey||''},
            {h:'Reason', f:(r)=> (r.cancelInfo && (r.cancelInfo.reason||'')) || ''},
            {h:'User', f:(r)=> (r.cancelInfo && (r.cancelInfo.user||'')) || ''},
            {h:'When', f:(r)=> (r.cancelInfo && (r.cancelInfo.DateTime||r.cancelInfo.time||'')) || ''},
          ])}
        </div>
      </div>
    `;

    const hist = (d.idHistory||[]).slice(0, 40);
    const histHtml = `
      <div class="section">
        <div class="sh"><b>id_history</b><span class="mini">${(d.idHistory||[]).length} evento(s)</span></div>
        <div class="sb">
          ${_renderMiniTable(hist, [
            {h:'Type', f:(r)=>r.Type||r.type||''},
            {h:'DateTime', f:(r)=>r.DateTime||''},
            {h:'User', f:(r)=>r.user||''},
            {h:'Batch', f:(r)=>r.batch||r.batchKey||''},
            {h:'Obs', f:(r)=>r.note||r.obs||''},
          ])}
        </div>
      </div>
    `;

    const regAll = (d.registosAll||[]).slice(0, 60);
    const regAllHtml = `
      <div class="section">
        <div class="sh"><b>registos (historico)</b><span class="mini">${(d.registosAll||[]).length} registo(s) ‚Ä¢ (mostra 60 mais recentes)</span></div>
        <div class="sb">
          ${_renderMiniTable(regAll, [
            {h:'Modo', f:(r)=>r.mode||r.Type||''},
            {h:'Data', f:(r)=>r.dateClean||''},
            {h:'Hora', f:(r)=>r.endTime||r.time||r.startTime||''},
            {h:'Batch', f:(r)=>r.batch||''},
            {h:'User', f:(r)=>r.user||''},
          ])}
        </div>
      </div>
    `;

    const rawJson = `<details class="raw"><summary>JSON completo</summary><pre class="json">${_safeTxt(JSON.stringify(d, null, 2))}</pre></details>`;

    $('idModalBody').innerHTML = summaryHtml + expectedHtml + packedHtml + returnsHtml + cancelledHtml + histHtml + regAllHtml + rawJson;
    $('idModal').style.display = 'flex';
  }

  function _lastEventLabel(hist){
    if(!hist || !hist.length) return '';
    const e = hist[0];
    const dt = e.DateTime || ((e.dateClean||'') + ' ' + (e.time||''));
    const t = e.Type || e.type || '';
    return (t ? t + ' ' : '') + (dt || '');
  }

  function renderDetailsTable(orderIds, carrierSet){
    const tbody = $('detailsTable').querySelector('tbody');
    tbody.innerHTML = '';
    const ids = orderIds || [];
    $('cDetails').textContent = ids.length;

    ids.forEach(id => {
      const d = lastResult.detailsById[id] || {};
      const inList = carrierSet.has(id);
      const expN = (d.expectedToday||[]).length;
      const packN = (d.packedToday||[]).length;
      const retN = (d.returnsToday||[]).length;
      const canN = (d.cancelledToday||[]).length;
      const batches = (d.expectedToday||[]).map(x=>x.batchKey).concat((d.cancelledToday||[]).map(x=>x.batchKey)).concat((d.packedToday||[]).map(x=>x.batch)).concat((d.returnsToday||[]).map(x=>x.batch)).filter(Boolean);
      const bUniq = Array.from(new Set(batches)).slice(0,6);
      const lastEv = _lastEventLabel(d.idHistory || []);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${_esc(id)}</b></td>
        <td>${_yesNoBadge(inList)}</td>
        <td>${expN ? `<span class="badge warn">${expN}</span>` : '<span class="badge">0</span>'}</td>
        <td>${packN ? `<span class="badge good">${packN}</span>` : '<span class="badge">0</span>'}</td>
        <td>${retN ? `<span class="badge warn">${retN}</span>` : '<span class="badge">0</span>'}</td>
        <td>${canN ? `<span class="badge bad">${canN}</span>` : '<span class="badge">0</span>'}</td>
        <td>${_esc(lastEv)}</td>
        <td>${_esc(bUniq.join(', '))}${batches.length>6 ? '‚Ä¶' : ''}</td>
        <td><button class="btn small" onclick="openIdModal('${_esc(id)}')">Ver</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function _safeOnce(ref){
    try{ return (await ref.once('value')).val() || {}; }
    catch(e){
      return null;
    }
  }

  async function _loadRegistosAllForIds(idsSet){
    if(!$('includeAllRegistos') || !$('includeAllRegistos').checked) return { used:false, map:{} };
    setStatus('A carregar registos (historico completo)‚Ä¶');
    const snap = await db.ref('registos').once('value');
    const all = snap.val() || {};
    const map = {};
    Object.entries(all).forEach(([k,r])=>{
      if(!r || !r.id) return;
      const id = String(r.id).trim().toUpperCase();
      if(!idsSet.has(id)) return;
      if(!map[id]) map[id] = [];
      map[id].push({ _key:k, ...r });
    });
    Object.keys(map).forEach(id=>{
      map[id].sort((a,b)=> String(b.dateClean||'').localeCompare(String(a.dateClean||'')) || String(b.time||b.endTime||'').localeCompare(String(a.time||a.endTime||'')));
    });
    return { used:true, map };
  }

  async function _loadIdHistoryForIds(ids){
    const out = {};
    await Promise.all(ids.map(async (id)=>{
      const snap = await db.ref('id_history/' + id).once('value');
      const v = snap.val() || {};
      const arr = Object.entries(v).map(([k,e])=>({ _key:k, ...e }));
      arr.sort((a,b)=> (Number(b.ts||0) - Number(a.ts||0)) || String(b.DateTime||'').localeCompare(String(a.DateTime||'')));
      out[id] = arr;
    }));
    return out;
  }

  function copyDetailsCsv(){
    const rows = (lastResult && lastResult.detailRows) ? lastResult.detailRows : [];
    if(!rows.length){ alert('Sem detalhes para copiar.'); return; }
    const cols = Object.keys(rows[0]);
    const lines = [cols.join('\t')].concat(rows.map(r=> cols.map(c=> String(r[c] ?? '')).replace(/\t/g,' ').replace(/\n/g,' ')).join('\t'));
    navigator.clipboard.writeText(lines.join('\n')).catch(()=>alert('Nao consegui copiar.'));
  }

  // Redefine runCrosscheck com ALL (expected + packed + cancelled) + detalhes completos por ID (intervalo de datas)
  runCrosscheck = async function() {
    const dateFrom = $('dateFrom').value;
    const dateTo = $('dateTo').value || dateFrom;
    const carriers = getSelectedCarriers();
    const compareMode = $('compareMode').value;
    const extraFilter = $('extraFilter').value;

    if (!dateFrom) { alert('Seleciona a data in√≠cio.'); return; }
    if (!dateTo) { alert('Seleciona a data fim (ou deixa em branco para assumir a data in√≠cio).'); return; }
    if (dateTo < dateFrom) { alert('A data fim n√£o pode ser anterior √† data in√≠cio.'); return; }
    if (!carriers.length) { alert('Seleciona pelo menos 1 transportadora.'); return; }

    const carrierIds = parseIds($('carrierIds').value);
    if (carrierIds.length === 0) { alert('Cola pelo menos 1 ID da transportadora.'); return; }

    setStatus('A cruzar‚Ä¶');
    setTechHint('');
    setKPIs([], [], []);
    $('detailsTable').querySelector('tbody').innerHTML = '';
    $('cDetails').textContent = '0';

    // 1) Buscar lotes no intervalo
    let batches = {};
    let usedFallbackBatches = false;
    try {
      const snap = await db.ref('active_batches').orderByChild('dateClean').startAt(dateFrom).endAt(dateTo).once('value');
      batches = snap.val() || {};
    } catch(e) {
      usedFallbackBatches = true;
      const snap = await db.ref('active_batches').once('value');
      const all = snap.val() || {};
      for (const k of Object.keys(all)) {
        const b = all[k] || {};
        const dc = String(b.dateClean || '');
        if (inRange(dc, dateFrom, dateTo)) batches[k] = b;
      }
    }

    const carriersSet = new Set(carriers.map(c => String(c||'').trim()));
    const batchKeys = Object.keys(batches).filter(k => carriersSet.has(String((batches[k]||{}).carrier||'').trim()));
    if (batchKeys.length === 0) {
      setStatus('Sem lotes encontrados para esse intervalo/transportadora(s).');
      setTechHint('Confirma se as transportadoras est√£o corretas e se os lotes t√™m dateClean e carrier preenchidos.');
      return;
    }

    // 2) Construir mapas de EXPECTED / CANCELLED por ID (dos lotes)
    const expectedToday = {}; // id -> [ {batchKey,batchName,carrier,dateClean,orderDetails,processed} ]
    const cancelledToday = {}; // id -> [ {batchKey,batchName,carrier,dateClean,cancelInfo} ]
    const expectedIdsAll = [];
    const cancelledIdsAll = [];

    for (const bk of batchKeys) {
      const b = batches[bk] || {};
      const bName = b.name || bk;
      const carr = b.carrier || '';
      const bDate = String(b.dateClean || '');

      const exp = Array.isArray(b.expected_ids) ? b.expected_ids : [];
      const processed = b.processed_ids || {};
      const orderDetails = b.order_details || {};

      exp.forEach(idRaw => {
        const id = String(idRaw).trim().toUpperCase();
        if(!id) return;
        if(!expectedToday[id]) expectedToday[id] = [];
        expectedToday[id].push({ batchKey: bk, batchName: bName, carrier: carr, dateClean: bDate, processed: !!processed[id], orderDetails: orderDetails[id] || null });
        expectedIdsAll.push(id);
      });

      const cancObj = b.cancelled_ids || {};
      Object.keys(cancObj).forEach(idRaw => {
        const id = String(idRaw).trim().toUpperCase();
        if(!id) return;
        if(!cancelledToday[id]) cancelledToday[id] = [];
        cancelledToday[id].push({ batchKey: bk, batchName: bName, carrier: carr, dateClean: bDate, cancelInfo: cancObj[idRaw] || null });
        cancelledIdsAll.push(id);
      });
    }


    // 2.b) Aviso de cancelamentos
    const carrierSet_ = toSet(carrierIds);
    const cancelSet = toSet(cancelledIdsAll);
    const cancelAll = Array.from(cancelSet);
    const cancelInCarrier = carrierIds.filter(id=>cancelSet.has(id));
    const cancelOnlySystem = cancelAll.filter(id=>!carrierSet_.has(id));
    showCancelBanner({cancelAll, cancelInCarrier, cancelOnlySystem, cancelledToday});

    // 3) Buscar PACKED (registos) no intervalo para esses lotes
    let registos = {};
    let usedFallbackReg = false;
    try {
      const snap = await db.ref('registos').orderByChild('dateClean').startAt(dateFrom).endAt(dateTo).once('value');
      registos = snap.val() || {};
    } catch(e) {
      usedFallbackReg = true;
      const snap = await db.ref('registos').once('value');
      const all = snap.val() || {};
      for (const k of Object.keys(all)) {
        const r = all[k] || {};
        const dc = String(r.dateClean || '');
        if (inRange(dc, dateFrom, dateTo)) registos[k] = r;
      }
    }

    const batchSet = new Set(batchKeys);
    const packedToday = {}; // id -> [registo]
    const packedIdsAll = [];
    Object.entries(registos).forEach(([k,r])=>{
      if(!r) return;
      if(!batchSet.has(r.batch)) return;
      if(extraFilter === 'ONLY_PACKING' && String(r.mode) !== 'PACKING') return;
      if(!r.id) return;
      const id = String(r.id).trim().toUpperCase();
      if(!packedToday[id]) packedToday[id] = [];
      packedToday[id].push({ _key:k, ...r });
      packedIdsAll.push(id);
    });

    // 3b) Buscar RETURNS (registos) no intervalo para esses lotes
    const returnsToday = {}; // id -> [registo]
    const returnsIdsAll = [];
    Object.entries(registos).forEach(([k,r])=>{
      if(!r) return;
      if(!batchSet.has(r.batch)) return;
      const modeRaw = String(r.mode || r.Type || '').trim().toUpperCase();
      const isReturn = (modeRaw === 'RETURNS' || modeRaw === 'RETURN' || modeRaw === 'RETURNED');
      if(!isReturn) return;
      if(!r.id) return;
      const id = String(r.id).trim().toUpperCase();
      if(!returnsToday[id]) returnsToday[id] = [];
      returnsToday[id].push({ _key:k, ...r });
      returnsIdsAll.push(id);
    });


    // 4) Escolher os IDs do sistema conforme o modo
    let systemIds = [];
    if (compareMode === 'EXPECTED') {
      // expected excluindo cancelados (mantem comportamento antigo)
      batchKeys.forEach(bk=>{
        const req = getRequiredBatchIds(batches[bk]||{});
        req.forEach(id=> systemIds.push(String(id).trim().toUpperCase()));
      });
      systemIds = Array.from(new Set(systemIds));

    } else if (compareMode === 'PACKED') {
      // apenas PACKING (ou ALL_MODES se selecionado no filtro)
      systemIds = Array.from(new Set(packedIdsAll));

    } else if (compareMode === 'RETURNS') {
      // apenas RETURNS
      systemIds = Array.from(new Set(returnsIdsAll));

    } else if (compareMode === 'PACKED_RETURNS') {
      const u = new Set();
      packedIdsAll.forEach(x=>u.add(x));
      returnsIdsAll.forEach(x=>u.add(x));
      systemIds = Array.from(u);

    } else if (compareMode === 'ALL_PLUS_RETURNS') {
      const u = new Set();
      expectedIdsAll.forEach(x=>u.add(x));
      packedIdsAll.forEach(x=>u.add(x));
      returnsIdsAll.forEach(x=>u.add(x));
      cancelledIdsAll.forEach(x=>u.add(x));
      systemIds = Array.from(u);

    } else {
      // ALL: union de expected + packed + cancelled
      const u = new Set();
      expectedIdsAll.forEach(x=>u.add(x));
      packedIdsAll.forEach(x=>u.add(x));
      cancelledIdsAll.forEach(x=>u.add(x));
      systemIds = Array.from(u);
    }

// 5) Cruzamento
    const carrierSet = toSet(carrierIds);
    const systemSet = toSet(systemIds);

    const matched = [];
    const missing = [];
    const extra = [];

    systemIds.forEach(id => {
      const nid = String(id).trim().toUpperCase();
      if (carrierSet.has(nid)) matched.push(nid);
      else missing.push(nid);
    });

    carrierIds.forEach(id => {
      const nid = String(id).trim().toUpperCase();
      if (!systemSet.has(nid)) extra.push(nid);
    });

    matched.sort();
    missing.sort();
    extra.sort();

    // 6) Detalhes por ID: ids colados + ids em falta
    const detailIds = Array.from(new Set([...carrierIds, ...missing])).slice(0, 500);
    const detailIdSet = new Set(detailIds);

    // carregar historico por ID (id_history) + (opcional) registos completos
    setStatus('A carregar historico por ID‚Ä¶');
    const idHistMap = await _loadIdHistoryForIds(detailIds);
    const regAll = await _loadRegistosAllForIds(detailIdSet);

    const detailsById = {};
    detailIds.forEach(id=>{
      detailsById[id] = {
        id,
        dateFrom,
        dateTo,
        carriers,
        inCarrierList: carrierSet.has(id),
        expectedToday: expectedToday[id] || [],
        packedToday: packedToday[id] || [],
        returnsToday: returnsToday[id] || [],
        cancelledToday: cancelledToday[id] || [],
        idHistory: idHistMap[id] || [],
        registosAll: (regAll.map[id] || [])
      };
    });

    // 7) Preparar linhas para export/copia
    const detailRows = detailIds.map(id=>{
      const d = detailsById[id];
      const lastEv = _lastEventLabel(d.idHistory);
      const batches = (d.expectedToday||[]).map(x=>x.batchKey).concat((d.cancelledToday||[]).map(x=>x.batchKey)).concat((d.packedToday||[]).map(x=>x.batch)).concat((d.returnsToday||[]).map(x=>x.batch)).filter(Boolean);
      const uniq = Array.from(new Set(batches));
      // agregar datas onde aparece
      const dates = (d.expectedToday||[]).map(x=>x.dateClean).concat((d.cancelledToday||[]).map(x=>x.dateClean)).concat((d.packedToday||[]).map(x=>x.dateClean)).concat((d.returnsToday||[]).map(x=>x.dateClean)).filter(Boolean);
      const uniqDates = Array.from(new Set(dates)).sort();
      return {
        DateFrom: dateFrom,
        DateTo: dateTo,
        Carriers: carriersLabel(carriers),
        ID: id,
        InCarrierList: d.inCarrierList ? 'YES' : 'NO',
        ExpectedCount: (d.expectedToday||[]).length,
        PackedCount: (d.packedToday||[]).length,
        ReturnsCount: (d.returnsToday||[]).length,
        CancelledCount: (d.cancelledToday||[]).length,
        DaysInvolved: uniqDates.join(', '),
        LastEvent: lastEv,
        Batches: uniq.join(', '),
        OrderDetails: (d.expectedToday && d.expectedToday[0] && d.expectedToday[0].orderDetails) ? JSON.stringify(d.expectedToday[0].orderDetails) : '',
        CancelInfo: (d.cancelledToday && d.cancelledToday[0] && d.cancelledToday[0].cancelInfo) ? JSON.stringify(d.cancelledToday[0].cancelInfo) : '',
        PackedSample: (d.packedToday && d.packedToday[0]) ? JSON.stringify(d.packedToday[0]) : ''
      };
    });

    lastResult = {
      dateFrom, dateTo, carriers, compareMode,
      matched, missing, extra,
      carrierIdsCount: carrierIds.length,
      systemIdsCount: systemIds.length,
      batchKeys,
      detailsById,
      detailIds,
      detailRows
    };

    setKPIs(matched, missing, extra);
    renderDetailsTable(detailIds, carrierSet);

    const hints = [];
    hints.push(`Intervalo: ${dateFrom} ‚Üí ${dateTo} ‚Ä¢ Carriers: ${carriersLabel(carriers)} ‚Ä¢ Base: ${compareMode}`);
    hints.push(`IDs transportadora: ${carrierIds.length} ‚Ä¢ IDs sistema: ${systemIds.length} ‚Ä¢ Lotes: ${batchKeys.length} ‚Ä¢ Detalhes: ${detailIds.length}`);
    hints.push(`Registos no intervalo ‚Äî PACKED: ${new Set(packedIdsAll).size} ‚Ä¢ RETURNS: ${new Set(returnsIdsAll).size}`);
    if (usedFallbackBatches) hints.push('Nota: query range por dateClean em active_batches falhou ‚Üí usado fallback full-scan.');
    if ((compareMode === 'PACKED' || compareMode === 'ALL') && usedFallbackReg) hints.push('Nota: query range por dateClean em registos falhou ‚Üí usado fallback full-scan.');
    if (regAll.used) hints.push('Inclui registos completos: SIM');
    else hints.push('Inclui registos completos: NAO');
    setTechHint(hints.join(' | '));

    setStatus('Concluido ‚úÖ');
  };

  // Override exportXlsx para incluir detalhes (FULL JSON + Tracking)
  const _exportXlsxOld = exportXlsx;
  exportXlsx = function(){
    const r = lastResult || {};
    if (!r.dateFrom) return alert('Ainda nao ha resultados.');

    // --- helpers ---
    function _j(v){ try{ return JSON.stringify(v ?? null); }catch(e){ return ''; } }
    function _safeStr(v){
      let s = (v === undefined || v === null) ? '' : String(v);
      // prevent formula injection
      if(/^[=+\-@]/.test(s)) s = "'" + s;
      // stop Excel from auto-linking urls (blue hyperlinks)
      s = s.replace(/(https?:\/\/)/gi, "\u200B$1");
      return s;
    }
    function _trackingFromObj(o){
      if(!o || typeof o !== 'object') return '';
      const keys = ['tracking','trackingNumber','tracking_number','track','awb','waybill','wayBill','guia','guiaTransporte','shippingLabel','label','etiqueta','trk','trkId'];
      for(const k of keys){
        if(o[k]) return String(o[k]);
      }
      if(o.shipment && typeof o.shipment==='object'){
        for(const k of keys){
          if(o.shipment[k]) return String(o.shipment[k]);
        }
      }
      return '';
    }
    function _extractTracking(d){
      const pools = []
        .concat((d && d.packedToday) ? d.packedToday : [])
        .concat((d && d.returnsToday) ? d.returnsToday : [])
        .concat((d && d.registosAll) ? d.registosAll : []);
      for(const rec of pools){
        const t = _trackingFromObj(rec);
        if(t) return t;
      }
      const exp = (d && d.expectedToday) ? d.expectedToday : [];
      for(const e of exp){
        const od = e && e.orderDetails;
        const t = _trackingFromObj(od);
        if(t) return t;
      }
      const hist = (d && d.idHistory) ? d.idHistory : [];
      for(const ev of hist){
        const t = _trackingFromObj(ev);
        if(t) return t;
        if(ev && ev.Tracking) return String(ev.Tracking);
      }
      return '';
    }
    function _statusForId(id){
      const u = String(id||'').toUpperCase();
      if((r.matched||[]).includes(u)) return 'MATCHED';
      if((r.missing||[]).includes(u)) return 'MISSING';
      if((r.extra||[]).includes(u)) return 'EXTRA';
      const d = (r.detailsById||{})[u];
      if(d && d.inCarrierList) return 'IN_LIST';
      return 'SYSTEM_ONLY';
    }
    function _sheetSanitize(ws){
      const range = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
      for(let R = range.s.r; R <= range.e.r; ++R){
        for(let C = range.s.c; C <= range.e.c; ++C){
          const addr = XLSX.utils.encode_cell({r:R,c:C});
          const cell = ws[addr];
          if(!cell) continue;
          if(cell.t === 's' || typeof cell.v === 'string'){
            cell.t = 's';
            cell.v = _safeStr(cell.v);
            if(cell.l) delete cell.l;
          }
        }
      }
      return ws;
    }

    try {
      const wb = XLSX.utils.book_new();

      // --- Summary ---
      const summary = [
        { Key: 'DateFrom', Value: r.dateFrom },
        { Key: 'DateTo', Value: r.dateTo },
        { Key: 'Carriers', Value: carriersLabel(r.carriers) },
        { Key: 'Base', Value: r.compareMode },
        { Key: 'IDs carrier', Value: r.carrierIdsCount },
        { Key: 'IDs system', Value: r.systemIdsCount },
        { Key: 'Matched', Value: (r.matched||[]).length },
        { Key: 'Missing', Value: (r.missing||[]).length },
        { Key: 'Extra', Value: (r.extra||[]).length },
        { Key: 'Batches', Value: (r.batchKeys || []).join(', ') }
      ];
      const wsSummary = _sheetSanitize(XLSX.utils.json_to_sheet(summary));
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

      // --- Lists ---
      const listRows = [];
      const add = (status, id) => listRows.push({ DateFrom: r.dateFrom, DateTo: r.dateTo, Carriers: carriersLabel(r.carriers), Base: r.compareMode, Status: status, ID: String(id||'') });
      (r.matched || []).forEach(id => add('MATCHED', id));
      (r.missing || []).forEach(id => add('MISSING', id));
      (r.extra || []).forEach(id => add('EXTRA', id));
      const wsLists = _sheetSanitize(XLSX.utils.json_to_sheet(listRows));
      XLSX.utils.book_append_sheet(wb, wsLists, 'Lists');

      // --- Details (light) ---
      const detailsLight = (r.detailRows || []).map(row=>{
        const out = {};
        Object.keys(row||{}).forEach(k=> out[k] = _safeStr(row[k]));
        return out;
      });
      const wsLight = _sheetSanitize(XLSX.utils.json_to_sheet(detailsLight));
      XLSX.utils.book_append_sheet(wb, wsLight, 'Details_light');

      // --- Details_FULL (all data + tracking + full JSON blobs) ---
      const detailsById = r.detailsById || {};
      const ids = (r.detailIds && r.detailIds.length) ? r.detailIds : Object.keys(detailsById);
      const fullRows = (ids || []).map(idRaw => {
        const id = String(idRaw||'').trim().toUpperCase();
        const d = detailsById[id] || {};
        const exp = d.expectedToday || [];
        const pack = d.packedToday || [];
        const ret = d.returnsToday || [];
        const can = d.cancelledToday || [];
        const hist = d.idHistory || [];
        const regAll = d.registosAll || [];

        const batches = []
          .concat(exp.map(x=>x.batchKey))
          .concat(can.map(x=>x.batchKey))
          .concat(pack.map(x=>x.batch))
          .concat(ret.map(x=>x.batch))
          .filter(Boolean);
        const uniqBatches = Array.from(new Set(batches));

        const dates = []
          .concat(exp.map(x=>x.dateClean))
          .concat(can.map(x=>x.dateClean))
          .concat(pack.map(x=>x.dateClean))
          .concat(ret.map(x=>x.dateClean))
          .filter(Boolean);
        const uniqDates = Array.from(new Set(dates)).sort();

        const orderDetails = (exp[0] && exp[0].orderDetails) ? exp[0].orderDetails : null;
        const cancelInfo = (can[0] && can[0].cancelInfo) ? can[0].cancelInfo : null;

        const tracking = _extractTracking(d);

        return {
          DateFrom: r.dateFrom,
          DateTo: r.dateTo,
          Carriers: carriersLabel(r.carriers),
          Base: r.compareMode,

          ID: id,
          Status: _statusForId(id),
          InCarrierList: d.inCarrierList ? 'YES' : 'NO',

          Tracking: tracking,

          ExpectedCount: exp.length,
          PackedCount: pack.length,
          ReturnsCount: ret.length,
          CancelledCount: can.length,

          DaysInvolved: uniqDates.join(', '),
          Batches: uniqBatches.join(', '),
          LastEvent: _safeStr(_lastEventLabel(hist)),

          OrderDetailsJSON: _safeStr(_j(orderDetails)),
          CancelInfoJSON: _safeStr(_j(cancelInfo)),
          ExpectedJSON: _safeStr(_j(exp)),
          PackedJSON: _safeStr(_j(pack)),
          ReturnsJSON: _safeStr(_j(ret)),
          CancelledJSON: _safeStr(_j(can)),
          IdHistoryJSON: _safeStr(_j(hist)),
          RegistosAllJSON: _safeStr(_j(regAll)),
          FullDataJSON: _safeStr(_j(d))
        };
      });

      const wsFull = _sheetSanitize(XLSX.utils.json_to_sheet(fullRows));
      XLSX.utils.book_append_sheet(wb, wsFull, 'Details_FULL');

      const filename = `carrier_crosscheck_fulldetails_${r.dateFrom}_to_${r.dateTo}_${String(carriersLabel(r.carriers)||'carriers').replace(/\s+/g,'_').replace(/,+/g,'+')}.xlsx`;
      XLSX.writeFile(wb, filename);
    } catch(e) {
      console.error(e);
      alert('Falha ao exportar (ver consola).');
    }
  }
</script>


</body>
</html>
